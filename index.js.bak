// index.js
//--------------------------------------------------------
// 1) ÐŸÐ¾Ð´Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð¸Ð· .env
require('dotenv').config({ path: __dirname + '/.env' });
console.log('ðŸ”‘ TELEGRAM_BOT_TOKEN =', process.env.TELEGRAM_BOT_TOKEN?.substring(0,8) + 'â€¦');
console.log('ðŸ”‘ OPENAI_API_KEY    =', process.env.OPENAI_API_KEY   ?.substring(0,8) + 'â€¦');

// 2) Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚Ñ‹ Ð¸ Ð¿Ð¾Ð»Ð¸Ñ„Ð¸Ð»Ð» fetch
const { Telegraf } = require('telegraf');
const { exec } = require('child_process');
const fs = require('fs');
const path = require('path');
global.fetch = (...args) =>
  import('node-fetch').then(({ default: fetch }) => fetch(...args));

const { OpenAI } = require('openai');
const pdfParse = require('pdf-parse');
const textract = require('textract');
const mammoth = require('mammoth');

// 3) ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ
if (!process.env.TELEGRAM_BOT_TOKEN) {
  console.error('âŒ TELEGRAM_BOT_TOKEN Ð½Ðµ Ð·Ð°Ð´Ð°Ð½ Ð² .env');
  process.exit(1);
}
if (!process.env.OPENAI_API_KEY) {
  console.error('âŒ OPENAI_API_KEY Ð½Ðµ Ð·Ð°Ð´Ð°Ð½ Ð² .env');
  process.exit(1);
}

// 4) Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ð±Ð¾Ñ‚Ð° Ð¸ OpenAI
const bot    = new Telegraf(process.env.TELEGRAM_BOT_TOKEN);
const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
const BASE_SYSTEM = {
  role: 'system',
  content:
    'Ð¢Ñ‹ â€” Ð¿Ð¾Ð¼Ð¾Ñ‰Ð½Ð¸Ðº, Ð¾Ð¿Ð¸ÑÑ‹Ð²Ð°ÑŽÑ‰Ð¸Ð¹ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹. ' +
    'ÐÐµ Ð½Ð°Ð·Ñ‹Ð²Ð°Ð¹ Ð»ÑŽÐ´ÐµÐ¹ Ð¿Ð¾ Ð»Ð¸Ñ†Ð°Ð¼ Ð¸ Ð½Ðµ Ñ€Ð°Ð·Ð³Ð»Ð°ÑˆÐ°Ð¹ Ð»Ð¸Ñ‡Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ.'
};
// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

// 5) Ð Ð°Ð±Ð¾Ñ‚Ð° Ñ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÐµÐ¹ Ð¿ÐµÑ€ÐµÐ¿Ð¸ÑÐºÐ¸
const HISTORY_PATH = path.join(__dirname, 'history.json');
let chatHistory = {};
try {
  chatHistory = JSON.parse(fs.readFileSync(HISTORY_PATH, 'utf-8'));
} catch {
  console.log('â„¹ï¸ history.json Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ â€” Ð±ÑƒÐ´ÐµÑ‚ ÑÐ¾Ð·Ð´Ð°Ð½ Ð¿Ñ€Ð¸ Ð¿ÐµÑ€Ð²Ð¾Ð¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¸');
}

function addToHistory(userId, role, content) {
  if (!chatHistory[userId]) chatHistory[userId] = [];
  chatHistory[userId].push({ role, content });
  // ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 20 ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
  if (chatHistory[userId].length > 20)
    chatHistory[userId] = chatHistory[userId].slice(-20);
  fs.writeFileSync(HISTORY_PATH, JSON.stringify(chatHistory, null, 2));
}

// 6) Ð¢ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ
bot.on('text', async (ctx) => {
  const userId = String(ctx.from.id);
  const text = ctx.message.text;
  addToHistory(userId, 'user', text);

  try {
    const resp = await openai.chat.completions.create({
      model: 'gpt-4',
      messages: chatHistory[userId],
    });
    const reply = resp.choices[0].message.content;
    await ctx.reply(reply);
    addToHistory(userId, 'assistant', reply);
  } catch (err) {
    console.error('âŒ GPT error:', err);
    await ctx.reply('ÐžÑˆÐ¸Ð±ÐºÐ° GPT: ' + err.message);
  }
});

// 7) Ð“Ð¾Ð»Ð¾ÑÐ¾Ð²Ñ‹Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ â†’ Whisper â†’ GPT-4
bot.on('voice', async (ctx) => {
  if (process.env.VOICE_TO_TEXT_ENABLED !== 'true') return;
  const userId = String(ctx.from.id);

  try {
    // 7.1. Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ ogg
    const fileId = ctx.message.voice.file_id;
    const link = await ctx.telegram.getFileLink(fileId);
    const ogg = `/tmp/${fileId}.ogg`;
    const wav = `/tmp/${fileId}.wav`;
    const res = await fetch(link.href);
    const buf = await res.arrayBuffer();
    fs.writeFileSync(ogg, Buffer.from(buf));

    // 7.2. ÐšÐ¾Ð½Ð²ÐµÑ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð² wav
    await new Promise((r, e) =>
      exec(`ffmpeg -i ${ogg} -ar 16000 -ac 1 ${wav}`, (err) =>
        err ? e(err) : r()
      )
    );

    // 7.3. Ð¢Ñ€Ð°Ð½ÑÐºÑ€Ð¸Ð±Ð¸Ñ€ÑƒÐµÐ¼ Whisper
    const transcription = await openai.audio.transcriptions.create({
      file: fs.createReadStream(wav),
      model: 'whisper-1',
      response_format: 'text',
      language: process.env.LANGUAGE || 'ru',
    });
    const userText = transcription.trim();
    addToHistory(userId, 'user', userText);

    // 7.4. Ð¨Ð»Ñ‘Ð¼ Ð² GPT-4
    const resp = await openai.chat.completions.create({
      model: 'gpt-4',
      messages: chatHistory[userId],
    });
    const reply = resp.choices[0].message.content;
    await ctx.reply(reply);
    addToHistory(userId, 'assistant', reply);

  } catch (err) {
    console.error('âŒ Voice error:', err);
    await ctx.reply('ÐžÑˆÐ¸Ð±ÐºÐ° Ð³Ð¾Ð»Ð¾ÑÐ°: ' + err.message);
  }
});

// 8) ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ñ„Ð¾Ñ‚Ð¾Ð³Ñ€Ð°Ñ„Ð¸Ð¹ Ñ‡ÐµÑ€ÐµÐ· GPT-4o Vision
bot.on('photo', async (ctx) => {
  const photos = ctx.message.photo;
  const fileId = photos[photos.length - 1].file_id;
  const file    = await ctx.telegram.getFile(fileId);
  const fileUrl = `https://api.telegram.org/file/bot${process.env.TELEGRAM_BOT_TOKEN}/${file.file_path}`;

  try {
    const resp = await openai.chat.completions.create({
      model: process.env.GPT_IMAGE_MODEL || 'gpt-4o',
      messages: [
        BASE_SYSTEM,
        {
          role: 'user',
          content: [
            { type: 'text',      text: 'ÐžÐ¿Ð¸ÑˆÐ¸, Ð¿Ð¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ñ‡Ñ‚Ð¾ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¾ Ð½Ð° ÑÑ‚Ð¾Ð¼ Ñ„Ð¾Ñ‚Ð¾.' },
            { type: 'image_url', image_url: { url: fileUrl } }
          ]
        }
      ],
      max_tokens: 1000
    });

    await ctx.reply(resp.choices[0].message.content);
  } catch (err) {
    console.error('âŒ Image error:', err);
    await ctx.reply('ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ.');
  }
});

(async () => {
  // 1) Ð£Ð´Ð°Ð»ÑÐµÐ¼ webhook, ÐµÑÐ»Ð¸ Ð±Ñ‹Ð»
  try {
    await bot.telegram.deleteWebhook();
    console.log('â„¹ Webhook ÑƒÐ´Ð°Ð»Ñ‘Ð½');
  } catch (e) {
    console.warn('âš  ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ webhook (Ð¸Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐµÐ¼):', e.description || e.message);
  }

  // 2) Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ polling Ð¸ ÑÑ€Ð°Ð·Ñƒ ÑÐ±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ Ð²ÑÐµ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð°Ð¿Ð´ÐµÐ¹Ñ‚Ñ‹
  try {
    await bot.launch({ dropPendingUpdates: true });
    console.log('âœ… Ð‘Ð¾Ñ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ (Polling, pending updates ÑÐ±Ñ€Ð¾ÑˆÐµÐ½Ñ‹)');
  } catch (e) {
    console.error('âŒ Launch error:', e);
    process.exit(1);
  }
})();

process.once('SIGINT', () => bot.stop('SIGINT'));
process.once('SIGTERM', () => bot.stop('SIGTERM'));
